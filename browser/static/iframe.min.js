(function(){var y=window.Ably=this,h={httpTransports:["xhr","iframe","jsonp"],transports:["web_socket","xhr","iframe","jsonp"],minified:!function(){}.name},z=function(){function a(){}a.addListener=function(a,b,f){a.addEventListener?a.addEventListener(b,f,!1):a.attachEvent("on"+b,function(){f.apply(a,arguments)})};a.removeListener=function(a,b,f){a.removeEventListener?a.removeEventListener(b,f,!1):a.detachEvent("on"+b,function(){f.apply(a,arguments)})};a.addMessageListener=function(e,b){a.addListener(e,
"message",b)};a.removeMessageListener=function(e,b){a.removeListener(e,"message",b)};a.addUnloadListener=function(e){a.addListener(window,"unload",e)};return a}();h.protocolVersion=1;h.ENVIRONMENT="";h.HOST="rest.ably.io";h.WS_HOST="realtime.ably.io";h.FALLBACK_HOSTS=["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"];h.PORT=80;h.TLS_PORT=443;h.connectTimeout=15E3;h.disconnectTimeout=3E4;h.suspendedTimeout=12E4;h.recvTimeout=9E4;h.sendTimeout=
1E4;h.connectionPersistTimeout=15E3;h.version="0.8.2";h.getHost=function(a,e,b){return e=b?e==a.host&&a.wsHost||e||a.wsHost:e||a.host};h.getPort=function(a,e){return e||a.tls?a.tlsPort:a.port};h.getHosts=function(a){var e=[a.host];(a=a.fallbackHosts)&&(e=e.concat(a));return e};h.normaliseOptions=function(a){if(a.host)a.wsHost=a.wsHost||a.host;else{var e=a.environment&&String(a.environment).toLowerCase()||h.ENVIRONMENT,b=!e||"production"===e;a.host=b?h.HOST:e+"-"+h.HOST;a.wsHost=b?h.WS_HOST:e+"-"+
h.WS_HOST;a.fallbackHosts=b?h.FALLBACK_HOSTS:a.fallbackHosts}a.port=a.port||h.PORT;a.tlsPort=a.tlsPort||h.TLS_PORT;"tls"in a||(a.tls=!0);return a};var A=function(){function a(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}a.prototype.on=function(a,b){1==arguments.length&&"function"==typeof a?this.any.push(a):null===a?this.any.push(b):(this.events[a]||(this.events[a]=[])).push(b)};a.prototype.off=function(a,b){if(0==arguments.length)this.any=[],this.events={},this.anyOnce=[],this.eventsOnce=
{};else{1==arguments.length&&"function"==typeof a&&(b=a,a=null);var f,g=-1;if(null===a)if(b){if(!(f=this.any)||-1==(g=n.arrIndexOf(f,b)))if(f=this.anyOnce)g=n.arrIndexOf(f,b);-1<g&&f.splice(g,1)}else this.any=[],this.anyOnce=[];else if(b){g=-1;if(!(f=this.events[a])||-1==(g=n.arrIndexOf(f,b)))if(f=this.eventsOnce[a])g=n.arrIndexOf(f,b);-1<g&&f.splice(g,1)}else delete this.events[a],delete this.eventsOnce[a]}};a.prototype.listeners=function(a){if(a){var b=this.events[a]||[];this.eventsOnce[a]&&Array.prototype.push.apply(b,
this.eventsOnce[a]);return b.length?b:null}return this.any.length?this.any:null};a.prototype.emit=function(a){function b(a){try{a.apply(g,f)}catch(b){throw k.logAction(k.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+b+"; stack = "+b.stack),b;}}var f=Array.prototype.slice.call(arguments,1),g={event:a};if(this.anyOnce.length){var d=this.anyOnce;this.anyOnce=[];for(var c=0;c<d.length;c++)b(d[c])}for(c=0;c<this.any.length;c++)this.any[c].apply(g,f);if(d=this.eventsOnce[a])for(delete this.eventsOnce[a],
c=0;c<d.length;c++)b(d[c]);if(d=this.events[a])for(c=0;c<d.length;c++)b(d[c])};a.prototype.once=function(a,b){1==arguments.length&&"function"==typeof a?this.anyOnce.push(a):null===a?this.anyOnce.push(b):(this.eventsOnce[a]||(this.eventsOnce[a]=[])).push(b)};return a}(),k=function(){function a(a){}var e=2,b=console&&function(){console.log.apply(console,arguments)};a.LOG_NONE=0;a.LOG_ERROR=1;a.LOG_MAJOR=2;a.LOG_MINOR=3;a.LOG_MICRO=4;a.LOG_DEFAULT=2;a.LOG_DEBUG=4;a.logAction=function(a,g,d){a<=e&&b("Ably: "+
g+": "+d)};a.setLog=function(a,g){void 0!==a&&(e=a);void 0!==g&&(b=g)};return a}(),C=function(){return function(a){a=a||[];var e=function(){for(var b=0;b<a.length;b++){var f=a[b];try{f.apply(null,arguments)}catch(g){}}};e.push=function(){Array.prototype.push.apply(a,arguments)};return e}}(),n=function(){function a(){}var e="object"==typeof window;a.mixin=function(a,b){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);return a};a.copy=function(f){return a.mixin({},f)};a.isArray=function(a){return"[object Array]"==
Object.prototype.toString.call(a)};a.isObject=function(a){return"[object Object]"==Object.prototype.toString.call(a)};a.isEmpty=function(a){for(var b in a)return!1;return!0};a.shallowClone=function(a){var b={},d;for(d in a)b[d]=a[d];return b};a.prototypicalClone=function(f,b){function d(){}d.prototype=f;var c=new d;b&&a.mixin(c,b);return c};a.inherits=function(f,b){f.super_=b;f.prototype=a.prototypicalClone(b.prototype,{constructor:f})};a.containsValue=function(a,b){for(var d in a)if(a[d]==b)return!0;
return!1};a.intersect=function(b,g){return a.isArray(g)?a.arrIntersect(b,g):a.arrIntersectOb(b,g)};a.isArray=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};a.arrIntersect=function(b,g){for(var d=[],c=0;c<b.length;c++){var e=b[c];-1!=a.arrIndexOf(g,e)&&d.push(e)}return d};a.arrIntersectOb=function(a,b){for(var d=[],c=0;c<a.length;c++){var e=a[c];e in b&&d.push(e)}return d};a.arrSubtract=function(b,g){for(var d=[],c=0;c<b.length;c++){var e=b[c];-1==
a.arrIndexOf(g,e)&&d.push(e)}return d};a.arrIndexOf=Array.prototype.indexOf?function(a,b,d){return a.indexOf(b,d)}:function(a,b,d){d=d||0;for(var c=a.length;d<c;d++)if(a[d]===b)return d;return-1};a.keysArray=function(a,b){var d=[],c;for(c in a)b&&!a.hasOwnProperty(c)||d.push(c);return d.length?d:void 0};a.valuesArray=function(a,b){var d=[],c;for(c in a)b&&!a.hasOwnProperty(c)||d.push(a[c]);return d.length?d:void 0};a.nextTick=e?function(a){setTimeout(a,0)}:process.nextTick;var b={json:"application/json",
jsonp:"application/javascript",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"};a.defaultGetHeaders=function(a){a=a||"json";return{accept:"json"===a?b.json:b[a]+","+b.json}};a.defaultPostHeaders=function(a){a=a||"json";return{accept:"json"===a?b.json:b[a]+","+b.json,"content-type":"json"===a?b.json:b[a]}};a.arrRandomElement=function(a){return a.splice(Math.floor(Math.random()*a.length))};a.toQueryString=function(a,b){var d=[],c=b&&-1<String(b).indexOf("?")?"&":"?";if(a)for(var e in a)d.push(encodeURIComponent(e)+
"="+encodeURIComponent(a[e]));return d.length?c+d.join("&"):""};a.parseQueryString=function(a){for(var b,d=/([^?&=]+)=?([^&]*)/g,c={};b=d.exec(a);)c[decodeURIComponent(b[1])]=decodeURIComponent(b[2]);return c};a.inspect=function(a){return JSON.stringify(a)};a.inspectError=function(b){return b&&"ErrorInfo"==b.constructor.name?b.toString():a.inspect(b)};return a}(),s=function(){function a(){this.presence=this.messages=this.msgSerial=this.channelSerial=this.channel=this.connectionSerial=this.connectionKey=
this.connectionId=this.error=this.count=this.timestamp=this.id=this.flags=this.action=void 0}var e="object"==typeof window?window.Ably.msgpack:(void 0)("msgpack-js");a.Action={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16};a.Flag={HAS_PRESENCE:0,HAS_BACKLOG:1};a.encode=function(a,f){return"msgpack"==f?e.encode(a,!0):JSON.stringify(a)};a.decode=function(b,f){var g="msgpack"==
f?e.decode(b):JSON.parse(String(b));return a.fromDecoded(g)};a.fromDecoded=function(b){var f=b.error;f&&(b.error=ErrorInfo.fromValues(f));var e=b.messages;if(e)for(f=0;f<e.length;f++)e[f]=Message.fromDecoded(e[f]);if(e=b.presence)for(f=0;f<e.length;f++)e[f]=PresenceMessage.fromDecoded(e[f]);return n.mixin(new a,b)};a.fromValues=function(b){return n.mixin(new a,b)};return a}(),x=function(){function a(){for(var a in c)c[a].dispose()}function e(){return window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest?
p=!0:s&&document.domain&&"https:"==window.location.protocol?!0:!1}function b(a,b,e,f,l){A.call(this);e=e||{};e.rnd=String(Math.random()).substr(2);this.uri=a+n.toQueryString(e,a);this.headers=b||{};this.body=f;this.requestMode=l;this.requestComplete=!1;c[this.id=String(++d)]=this}function f(a,e,d,f,l){d.ua="xdr";b.call(this,a,e,d,f,l)}var g=function(){},d=0,c={},s=window.XDomainRequest,p;n.inherits(b,A);b.isAvailable=e;var l=b.createRequest=function(a,e,d,l,c){return p?new b(a,e,d,l,c):new f(a,e,
d,l,c)};b.prototype.complete=function(a,b,e,d){this.requestComplete||(this.requestComplete=!0,b&&this.emit("data",b),this.emit("complete",a,b,e,d),this.dispose())};b.prototype.abort=function(){this.dispose()};b.prototype.exec=function(){function a(){r=c.responseText;for(var b=r.length-1,d,e;v<b&&-1<(d=r.indexOf("\n",v));){e=r.slice(v,d);v=d+1;a:{try{e=JSON.parse(e)}catch(f){e=Error("Malformed response body from server: "+f.message);e.statusCode=400;g.complete(e);break a}g.emit("data",e)}}}function b(){a();
g.streamComplete=!0;n.nextTick(function(){g.complete()})}var e=this.timer=setTimeout(function(){c.abort()},0==this.requestMode?h.sendTimeout:h.recvTimeout),d=this.body,l=d?"POST":"GET",f=this.headers,c=this.xhr=new XMLHttpRequest,g=this,k=f.accept,p="text";k?"application/json"!=k&&(p="arraybuffer"):f.accept="application/json";d&&"application/json"==(f["content-type"]||(f["content-type"]="application/json"))&&"string"!=typeof d&&(d=JSON.stringify(d));c.open(l,this.uri,!0);c.responseType=p;"authorization"in
f&&(c.withCredentials="true");for(var u in f)c.setRequestHeader(u,f[u]);var m=c.onerror=function(a){a.code=8E4;g.complete(a)};c.onabort=function(){var a=Error("Request cancelled");a.statusCode=400;m(a)};c.ontimeout=function(){var a=Error("Request timed out");a.statusCode=408;m(a)};var t,q,r,w,v=0,B=!1;c.onreadystatechange=function(){var d=c.readyState;if(!(3>d)&&0!==c.status)if(void 0===q&&(q=c.status,1223===q&&(q=204),clearTimeout(e),w=400>q,204==q?g.complete():t=3==g.requestMode&&w),3==d&&t)a();
else if(4==d)if(t)b();else a:{try{var f=c.getResponseHeader&&c.getResponseHeader("content-type"),l=f?"application/json"==f:"text"==c.responseType;r=l?c.responseText:c.response;if(!r){204!=status&&(k=Error("Incomplete response body from server"),k.statusCode=400,g.complete(k));break a}l&&(r=JSON.parse(String(r)),B=!0)}catch(h){var k=Error("Malformed response body from server: "+h.message);k.statusCode=400;g.complete(k);break a}w?g.complete(null,r,f&&{"content-type":f},B):(k=r.error,k||(k=Error("Error response received from server: "+
q),k.statusCode=q),g.complete(k))}};c.send(d)};b.prototype.dispose=function(){var a=this.xhr;if(a){a.onreadystatechange=a.onerror=a.onabort=a.ontimeout=g;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||a.abort()}delete c[this.id]};n.inherits(f,b);f.prototype.exec=function(){function a(){clearTimeout(e);if(m=l.responseText){var b=m.length-1;if("\n"==m[b]||(b=-1<m.indexOf("\n"))){var d=m.slice(0,b);try{var d=JSON.parse(d),c=d.error;if(c)u=c.statusCode||500,
g.complete(c);else if(u=m?201:200,s=3==g.requestMode)t=b,n.isEmpty(d)||g.emit("data",d)}catch(f){c=Error("Malformed response body from server: "+f.message),c.statusCode=400,g.complete(c)}}}}function b(){m=l.responseText;for(var a=m.length-1,c,d;t<a&&-1<(c=m.indexOf("\n",t));){d=m.slice(t,c);t=c+1;a:{try{d=JSON.parse(d)}catch(e){d=Error("Malformed response body from server: "+e.message);d.statusCode=400;g.complete(d);break a}g.emit("data",d)}}}function d(){b();g.streamComplete=!0;n.nextTick(function(){g.complete()})}
var e=this.timer=setTimeout(function(){l.abort()},0==this.requestMode?h.sendTimeout:h.recvTimeout),c=this.body,f=c?"POST":"GET",l=this.xhr=new XDomainRequest,g=this;c&&"object"==typeof c&&(c=JSON.stringify(c));var p=l.onerror=function(){k.logAction(k.LOG_ERROR,"Request.onerror()","");var a=Error("Error response");a.statusCode=400;a.code=8E4;g.complete(a)};l.onabort=function(){k.logAction(k.LOG_ERROR,"Request.onabort()","");var a=Error("Request cancelled");a.statusCode=400;p(a)};l.ontimeout=function(){k.logAction(k.LOG_ERROR,
"Request.timeout()","");var a=Error("Request timed out");a.statusCode=408;p(a)};var s,u,m,t=0;l.onprogress=function(){void 0===u?a():s&&b()};l.onload=function(){if(void 0===u&&(a(),g.requestComplete))return;if(s)d();else a:{try{m=l.responseText;if(!m||!m.length){204!=status&&(c=Error("Incomplete response body from server"),c.statusCode=400,g.complete(c));break a}m=JSON.parse(String(m))}catch(b){var c=Error("Malformed response body from server: "+b.message);c.statusCode=400;g.complete(c);break a}g.complete(null,
m,{"content-type":"application/json"},!0)}};try{l.open(f,this.uri),l.send(c)}catch(q){k.logAction(k.LOG_ERROR,"Request.onStreamEnd()","Unexpected send exception; err = "+q),p(q)}};f.prototype.dispose=function(){var a=this.xhr;if(a){a.onprogress=a.onload=a.onerror=a.onabort=a.ontimeout=g;this.xhr=null;var b=this.timer;b&&(clearTimeout(b),this.timer=null);this.requestComplete||a.abort()}delete c[this.id]};if(e=b.isAvailable())z.addUnloadListener(a),"undefined"!==typeof Http&&(Http.supportsAuthHeaders=
p,Http.Request=function(a,b,c,d,e){a=l(a,b,c,d,0);a.once("complete",e);a.exec();return a});return b}();(function(){function a(a){"string"!=typeof a&&(a=JSON.stringify(a));return a}function e(a){"string"==typeof a&&(a=JSON.parse(a));return a}function b(){this.stream="stream"in g?g.stream:!0;this.baseUri=this.sendUri=this.recvUri=this.pendingItems=this.pendingCallback=this.recvRequest=this.sendRequest=null;var a=this;z.addMessageListener(window,function(b){a.onMessageEvent(b.data)})}var f=location.origin||
location.protocol+"//"+location.hostname+(location.port?":"+location.port:""),g=n.parseQueryString(window.location.search),d=g.origin;delete g.origin;var c="access_token"in g?{access_token:g.access_token}:{key:g.key},h=window.parent,p=s.Action;b.prototype.connect=function(){var a=(this.baseUri=f+"/comet/")+"connect",b=this;k.logAction(k.LOG_MINOR,"IframeAgent.connect()","uri: "+a);a=this.recvRequest=x.createRequest(a,null,g,null,this.stream?3:1);a.on("data",function(a){null==b.sendUri&&b.checkConnectResponse(a);
b.onData(a)});a.on("complete",function(a){b.recvRequest=null;a&&b.postErrorEvent(a)});a.exec()};b.prototype.dispose=function(){this.recvRequest&&(this.recvRequest.abort(),this.recvRequest=null)};b.prototype.checkConnectResponse=function(a){try{var b=e(a);if(b&&b.length)for(a=0;a<b.length;a++){var c=b[a];if(c.action==p.CONNECTED){this.onConnect(c);break}}}catch(d){k.logAction(k.LOG_ERROR,"IframeAgent.checkConnectResponse()","Unexpected exception handing channel event: "+d)}};b.prototype.onConnect=
function(a){a=this.baseUri+a.connectionKey;k.logAction(k.LOG_MICRO,"IframeAgent.onConnect()","baseUri = "+a);this.sendUri=a+"/send";this.recvUri=a+"/recv";var b=this;n.nextTick(function(){b.recv()})};b.prototype.onMessageEvent=function(a){var b=this;this.send(e(a),function(a,c){a?b.postErrorEvent(a):c&&b.postMessageEvent(c)})};b.prototype.send=function(a,b){k.logAction(k.LOG_MICRO,"IframeAgent.send()","msg = "+JSON.stringify(a));if(this.sendRequest)this.pendingItems=this.pendingItems||[],this.pendingItems.push(a),
this.pendingCallback=this.pendingCallback||C(),this.pendingCallback.push(b);else{var c=this.pendingItems||[];c.push(a);this.pendingItems=null;var d=this.pendingCallback;d&&(d.push(b),b=d,this.pendingCallback=null);this.sendItems(c,b)}};b.prototype.sendItems=function(b,d){var e=this.sendUri,f=this;e?(e=this.sendRequest=x.createRequest(e,null,c,a(b),0),e.on("complete",function(a,b){a&&k.logAction(k.LOG_ERROR,"IframeAgent.sendItems()","on complete: err = "+n.inspectError(a));f.sendRequest=null;if(b)f.onData(b);
var c=f.pendingItems;if(c){f.pendingItems=null;var e=f.pendingCallback;f.pendingCallback=null;n.nextTick(function(){f.sendItems(c,e)})}d(a)}),e.exec()):d({message:"Unable to send; not connected",code:8E4,statusCode:400})};b.prototype.recv=function(){if(!this.recvRequest&&this.isConnected){var a=this,b=this.recvRequest=x.createRequest(this.recvUri,null,c,null,a.stream?3:2);b.on("data",function(b){a.onData(b)});b.on("complete",function(b){a.recvRequest=null;b?a.postErrorEvent(b):n.nextTick(function(){a.recv()})});
b.exec()}};b.prototype.onData=function(a){this.postMessageEvent(a)};b.prototype.postMessageEvent=function(b){h.postMessage(a(b),d)};b.prototype.postErrorEvent=function(a,b){var c=b;if(a){var d=new s.fromValues({action:p.ERROR,error:a});c&&n.mixin(d,c);c=d}this.postMessageEvent([c])};(new b).connect()})();"undefined"!==typeof Realtime&&(y.Rest=Rest,y.Realtime=Realtime,Realtime.ConnectionManager=ConnectionManager,Realtime.BufferUtils=Rest.BufferUtils=BufferUtils,"undefined"!==typeof Crypto&&(Realtime.Crypto=
Rest.Crypto=Crypto),Realtime.Defaults=Rest.Defaults=h,Realtime.Message=Rest.Message=Message,Realtime.PresenceMessage=Rest.PresenceMessage=PresenceMessage,Realtime.ProtocolMessage=Rest.ProtocolMessage=s)}).call({});
