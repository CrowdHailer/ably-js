(function(){var l=function(){function a(){this.any=[];this.events={};this.anyOnce=[];this.eventsOnce={}}a.prototype.on=function(a,b){1==arguments.length&&"function"==typeof a?this.any.push(a):null===a?this.any.push(b):(this.events[a]||(this.events[a]=[])).push(b)};a.prototype.off=function(a,b){if(0==arguments.length)this.any=[],this.events={},this.anyOnce=[],this.eventsOnce={};else{1==arguments.length&&"function"==typeof a&&(b=a,a=null);var c,f=-1;if(null===a)if(b){if(!(c=this.any)||-1==(f=g.arrIndexOf(c,
b)))if(c=this.anyOnce)f=g.arrIndexOf(c,b);-1<f&&c.splice(f,1)}else this.any=[],this.anyOnce=[];else if(b){f=-1;if(!(c=this.events[a])||-1==(f=g.arrIndexOf(c,b)))if(c=this.eventsOnce[a])f=g.arrIndexOf(c,b);-1<f&&c.splice(f,1)}else delete this.events[a],delete this.eventsOnce[a]}};a.prototype.listeners=function(a){if(a){var b=this.events[a]||[];this.eventsOnce[a]&&Array.prototype.push.apply(b,this.eventsOnce[a]);return b.length?b:null}return this.any.length?this.any:null};a.prototype.emit=function(a){function b(a){try{a.apply(f,
c)}catch(d){throw Logger.logAction(Logger.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+d+"; stack = "+d.stack),d;}}var c=Array.prototype.slice.call(arguments,1),f={event:a};if(this.anyOnce.length){var d=this.anyOnce;this.anyOnce=[];for(var e=0;e<d.length;e++)b(d[e])}for(e=0;e<this.any.length;e++)this.any[e].apply(f,c);if(d=this.eventsOnce[a])for(delete this.eventsOnce[a],e=0;e<d.length;e++)b(d[e]);if(d=this.events[a])for(e=0;e<d.length;e++)b(d[e])};a.prototype.once=function(a,
b){1==arguments.length&&"function"==typeof a?this.anyOnce.push(a):null===a?this.anyOnce.push(b):(this.eventsOnce[a]||(this.eventsOnce[a]=[])).push(b)};return a}(),g=function(){function a(){}var g="object"==typeof window;a.mixin=function(c,a){for(var d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);return c};a.copy=function(c){return a.mixin({},c)};a.isArray=function(c){return"[object Array]"==Object.prototype.toString.call(c)};a.isObject=function(c){return"[object Object]"==Object.prototype.toString.call(c)};
a.isEmpty=function(c){for(var a in c)return!1;return!0};a.shallowClone=function(c){var a={},d;for(d in c)a[d]=c[d];return a};a.prototypicalClone=function(c,f){function d(){}d.prototype=c;var e=new d;f&&a.mixin(e,f);return e};a.inherits="undefined"!==typeof require&&require("util").inherits||function(c,f){c.super_=f;c.prototype=a.prototypicalClone(f.prototype,{constructor:c})};a.containsValue=function(c,a){for(var d in c)if(c[d]==a)return!0;return!1};a.intersect=function(c,f){return a.isArray(f)?a.arrIntersect(c,
f):a.arrIntersectOb(c,f)};a.isArray=Array.isArray?Array.isArray:function(c){return"[object Array]"===Object.prototype.toString.call(c)};a.arrIntersect=function(c,f){for(var d=[],e=0;e<c.length;e++){var b=c[e];-1!=a.arrIndexOf(f,b)&&d.push(b)}return d};a.arrIntersectOb=function(c,a){for(var d=[],e=0;e<c.length;e++){var b=c[e];b in a&&d.push(b)}return d};a.arrSubtract=function(c,f){for(var d=[],e=0;e<c.length;e++){var b=c[e];-1==a.arrIndexOf(f,b)&&d.push(b)}return d};a.arrIndexOf=Array.prototype.indexOf?
function(c,a,d){return c.indexOf(a,d)}:function(a,b,d){d=d||0;for(var e=a.length;d<e;d++)if(a[d]===b)return d;return-1};a.keysArray=function(a,b){var d=[],e;for(e in a)b&&!a.hasOwnProperty(e)||d.push(e);return d.length?d:void 0};a.valuesArray=function(a,b){var d=[],e;for(e in a)b&&!a.hasOwnProperty(e)||d.push(a[e]);return d.length?d:void 0};a.nextTick=g?function(a){setTimeout(a,0)}:process.nextTick;var b={json:"application/json",jsonp:"application/javascript",xml:"application/xml",html:"text/html",
msgpack:"application/x-msgpack"};a.defaultGetHeaders=function(a){a=a||"json";return{accept:"json"===a?b.json:b[a]+","+b.json}};a.defaultPostHeaders=function(a){a=a||"json";return{accept:"json"===a?b.json:b[a]+","+b.json,"content-type":"json"===a?b.json:b[a]}};a.arrRandomElement=function(a){return a.splice(Math.floor(Math.random()*a.length))};a.toQueryString=function(a,b){var d=[],e=b&&-1<String(b).indexOf("?")?"&":"?";if(a)for(var g in a)d.push(encodeURIComponent(g)+"="+encodeURIComponent(a[g]));
return d.length?e+d.join("&"):""};a.parseQueryString=function(a){for(var b,d=/([^?&=]+)=?([^&]*)/g,e={};b=d.exec(a);)e[decodeURIComponent(b[1])]=decodeURIComponent(b[2]);return e};a.inspect=function(a){return JSON.stringify(a)};a.inspectError=function(c){return c&&"ErrorInfo"==c.constructor.name?c.toString():a.inspect(c)};return a}();(function(){function a(a,c){var b=c.host||"",e=c.tlshost||"",h={key:a,tls:c.encrypted||!1,log:{level:4}};c.ablyClientId&&(h.clientId=c.ablyClientId);c.authEndpoint&&
(h.authUrl=c.authEndpoint);c.auth&&c.auth.params&&(h.authParams=c.auth.params);c.auth&&c.auth.headers&&(h.authHeaders=c.auth.headers);b&&0!=b.length&&(b=b.split(":"),h.host=h.wsHost=b[0],1<b.length&&(h.port=b[1]));e&&0!=e.length&&(b=e.split(":"),1<b.length&&(h.tlsPort=b[1]));e=this.ably=new (d||window.Ably).Realtime(h);this.clientId=h.clientId;this.connection=new k(e.connection);this.channels={}}function k(a){l.call(this);this.connection=a;var c=this;a.on(function(a){var b=m[a.previous],d=c.state=
m[a.current];c.emit(d);c.emit("state_change",{previous:b,current:d});a.retryIn&&c.emit("connecting_in",a.retryIn)})}function b(a,c){var b=this;this.active=!0;this.channel=a.ably.channels.get(c);this.name=c;if(this.isPresence=0==c.indexOf("presence-"))this.members=new f(this,a.clientId);this.channel.subscribe(function(a){JSON.stringify(this);JSON.stringify(a);b.channel.emit(a.name,a.data)});this.bindings={};this.bind_alls=[];if(this.isPresence){var d=this.channel.presence;this.entered=!1;d.on("enter",
function(a){b.entered&&a.clientId!==b.members.myID&&(a=b.members.addMember(a.clientId,a.clientInfo))&&b.channel.emit("pusher:member_added",a)});d.on("leave",function(a){b.entered&&(a=b.members.removeMember(a.clientId))&&b.channel.emit("pusher:member_removed",a)});d.enter(function(a){if(a=d.get())for(var c=0;c<a.length;c++)b.members.addMember(a[c].clientId,a[c].clientData);b.entered=!0;b._sendEvent("pusher:subscription_succeeded",b.members)})}this.channel.on(function(a){"attached"===this.event&&b.isPresence||
("undefined"===typeof a&&(a={}),b._sendEvent(r[this.event]||this.event,a))})}function c(a,c){this.id=a;this.info=c}function f(a,c,b){this.count=0;this.members={};c&&(this.myID=c,this.me=this.addMember(c,b))}if("undefined"!==typeof window)var d=window.Ably;else if("undefined"===typeof d){var d=require("../.."),e=require("fs"),p=require("path"),q=require("vm"),n=function(a){a=p.resolve(__dirname,a);return q.runInThisContext(e.readFileSync(a,"utf8"),a)};"undefined"===typeof g&&n("../../common/lib/util/utils.js");
"undefined"===typeof l&&n("../../common/lib/util/eventemitter.js")}var m={initialized:"initialized",connecting:"connecting",connected:"connected",disconnected:"disconnected",suspended:"unavailable",closed:"disconnected",failed:"failed"},r={attached:"pusher:subscription_succeeded",failed:"pusher:subscription_error"};a.prototype.disconnect=function(){this.ably.close();delete this.ably};a.prototype.channel=function(a){return this.channels[a]};a.prototype.subscribe=function(a){return this.channels[a]=
new b(this,a)};a.prototype.unsubscribe=function(a){var c=this.channels[a];c&&(c.channel.detach(),c.active=!1,delete this.channels[a])};g.inherits(k,l);k.prototype.bind=function(){this.on.apply(this,arguments)};k.prototype.unbind=function(){this.off.apply(this,arguments)};b.prototype._sendEvent=function(a,c){for(var b=0;b<this.bind_alls.length;b++)this.bind_alls[b](a,c);var d=this.bindings[a];if(d)for(b=0;b<d.length;b++)d[b](c)};b.prototype.bind_all=function(a){this.bind_alls.push(a)};b.prototype.unbind=
function(a,c){var b=this.bindings[a];if(b)for(var d=0;d<b.length;d++)if(b[d]===c){b.splice(d,1);0==b.length&&(this.channel.off(a,this.channelBindCallback),delete this.bindings[a]);break}};b.prototype.bind=function(a,c){this.bindings[a]?this.bindings[a].push(c):this.bindings[a]=[c]};b.prototype.trigger=function(a,c){JSON.stringify(c);if(!this.active)return!0;this.channel.publish(a,c);return!0};f.prototype.addMember=function(a,b){"undefined"===typeof b&&(b={});a in this.members?this.members[a]=b:(this.members[a]=
b,this.count++);return new c(a,b)};f.prototype.removeMember=function(a){if(a in this.members){var b=this.members[a];delete this.members[a];this.count--;return new c(a,b)}};f.prototype.each=function(a){for(var b in this.members)a(new c(b,this.members[b]))};f.prototype.get=function(a){return this.members[a]};"undefined"===typeof window?module.exports=a:window.Pusher=a})()})();
